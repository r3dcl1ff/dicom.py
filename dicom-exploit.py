from pynetdicom import AE
from pynetdicom.sop_class import PatientRootQueryRetrieveInformationModelFind
from pydicom import Dataset
import argparse

# Argument parser
parser = argparse.ArgumentParser(description='Perform DICOM Association')
parser.add_argument('-t', '--target', required=True, help='Target IP Address')
args = parser.parse_args()

# Use the provided target IP address
ip = args.target
port = 104

# Setup the DICOM Association
ae = AE()
ae.add_requested_context(PatientRootQueryRetrieveInformationModelFind)
association = ae.associate(ip, port)

# Code logic remains the same
if association.is_established:
    print('[+] Association established!')

    dataset = Dataset()
    dataset.PatientName = '*'
    dataset.PatientID = ''
    dataset.PatientSex = ''
    dataset.PatientBirthDate = ''
    dataset.StudyDescription = ''
    dataset.QueryRetrieveLevel = "PATIENT"

    results = association.send_c_find(dataset, query_model=PatientRootQueryRetrieveInformationModelFind)

    for (status, dataset) in results:
        if status.Status in (0xFF00, 0xFF01):
            print(dataset)
            print('')

    association.release()
